<ui:composition
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:ui="jakarta.faces.facelets"
        xmlns:h="jakarta.faces.html"
        xmlns:f="jakarta.faces.core"
        xmlns:p="http://primefaces.org/ui"
        xmlns:ues="jakarta.faces.composite/ues"
        template="/WEB-INF/plantilla/default.xhtml">

    <f:metadata>
        <f:viewParam name="archivoId" value="#{transaccionFrm.idArchivoSeleccionado}"/>
        <f:viewAction action="#{transaccionFrm.cargarTransaccionesDelArchivo}"/>
    </f:metadata>

    <ui:define name="header">
        <h1>Gestión de Transacciones</h1>
    </ui:define>

    <!-- tabla -->
    <ui:define name="contenido-tabla">
        <h:panelGrid>
            <h:form id="frmTablaTransacciones">

                <p:dataTable lazy="true"
                             rendered="#{transaccionFrm.estado == 'NADA'}"
                             rows="50"
                             paginator="true"
                             paginatorPosition="bottom"
                             value="#{transaccionFrm.listaTransacciones}"
                             var="t"
                             rowKey="#{t.id}"
                             selectionMode="single"
                             selection="#{transaccionFrm.registro}"
                             styleClass="tabla-crud">

                    <p:ajax event="rowSelect"
                            listener="#{transaccionFrm.seleccionarRegistro}"
                            update=":pnlDetalle :pnlTabla"/>

                    <p:column headerText="Fecha">
                        <h:outputText value="#{t.fecha}">
                            <f:convertDateTime pattern="dd/MM/yyyy"/>
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Descripción">
                        <h:outputText value="#{t.descripcion}"/>
                    </p:column>

                    <p:column headerText="Monto">
                        <h:outputText value="$#{t.monto}"/>
                    </p:column>

                    <p:column headerText="Moneda">
                        <h:outputText value="#{t.moneda}"/>
                    </p:column>

                </p:dataTable>

                <ues:botones-top formulario="#{transaccionFrm}" actualizar=":pnlDetalle :pnlTabla"/>

            </h:form>
        </h:panelGrid>
    </ui:define>

    <!-- detalla -->
    <ui:define name="contenido-detalle">

        <p:tabView id="tabTransaccion"
                   cache="false"
                   dynamic="true"
                   rendered="#{transaccionFrm.estado != 'NADA'}">
            <p:tab closable="false" title="Detalle de transacción">

                <h:panelGroup id="pnlTransaccionWrapper">
                    <h:form id="frmTransaccionCrear">

                        <h:panelGrid columns="2">

                            <p:outputLabel for="txtIdTrans" value="ID:"/>
                            <p:inputText id="txtIdTrans"
                                         value="#{transaccionFrm.registro.id}"
                                         readonly="true"
                                         disabled="true"/>

                            <p:outputLabel for="dpFechaTrans" value="Fecha:"/>
                            <p:datePicker id="dpFechaTrans"
                                          value="#{transaccionFrm.registro.fecha}"
                                          pattern="yyyy-MM-dd"
                                          required="true"
                                          showIcon="true"
                                          touchUI="false"/>

                            <p:outputLabel for="txtDescripcion" value="Descripción:"/>
                            <p:inputTextarea id="txtDescripcion"
                                             value="#{transaccionFrm.registro.descripcion}"
                                             rows="3" cols="30"
                                             required="true"
                                             requiredMessage="La descripción es obligatoria."/>

                            <p:outputLabel for="txtMonto" value="Monto:"/>
                            <p:inputNumber id="txtMonto"
                                           value="#{transaccionFrm.registro.monto}"
                                           symbol="$"
                                           required="true"/>

                            <p:outputLabel for="cmbMoneda" value="Moneda:"/>
                            <p:selectOneMenu id="cmbMoneda"
                                             value="#{transaccionFrm.registro.moneda}">
                                <f:selectItem itemLabel="USD" itemValue="USD"/>
                            </p:selectOneMenu>

                        </h:panelGrid>

                        <ues:botones-crud
                                formulario="#{transaccionFrm}"
                                actualizar=":pnlTabla :tabTransaccion"/>

                    </h:form>
                </h:panelGroup>

            </p:tab>

            <!-- clasificacion -->
            <p:tab title="Clasificación Contable"
                   disabled="#{transaccionFrm.estado != 'MODIFICAR'}">
                <h:panelGrid>

                    <h:panelGroup id="pnlClasificacion">
                        <h:form id="frmClasificacion">
                            <h:panelGrid columns="2">
                                <h:outputLabel value="Tipo de Transacción:"/>
                                <p:selectOneMenu
                                        value="#{transaccionFrm.transaccionClasificacionFrm.registro.tipoTransaccion}"
                                        rendered="#{transaccionFrm.estado == 'MODIFICAR'}">

                                    <f:selectItem itemLabel="Seleccione" itemValue="#{null}"/>
                                    <f:selectItem itemLabel="COMPRA" itemValue="COMPRA"/>
                                    <f:selectItem itemLabel="VENTA" itemValue="VENTA"/>
                                </p:selectOneMenu>

                                <p:outputLabel for="acCategoria" value="Categoria :"/>
                                <h:panelGrid>
                                    <h:panelGrid columns="2">
                                        <p:outputLabel value="Seleccione la categoria: " for="acCategoria"/>
                                        <p:autoComplete id="acCategoria"
                                                        value="#{transaccionClasificacionFrm.categoriaSeleccionada}"
                                                        completeMethod="#{transaccionClasificacionFrm.completarCategoria}"
                                                        var="categoria"
                                                        converter="categoriaConversor"
                                                        itemLabel="#{categoria.nombre}"
                                                        itemValue="#{categoria}"
                                                        forceSelection="true"
                                                        dropdown="true"
                                                        size="40"
                                                        placeholder="Ingrese el nombre de la caracteristica"
                                                        emptyMessage="No se encontraron caracteristica con ese nombre"

                                        />
                                    </h:panelGrid>
                                </h:panelGrid>


                                <h:panelGrid>
                                    <h:outputLabel value="Descripción de Categoría:"/>
                                    <h:outputText value="#{transaccionFrm.transaccionClasificacionFrm.registro.categoria.descripcion}"
                                                  rendered="#{not empty transaccionFrm.transaccionClasificacionFrm.registro and not empty transaccionFrm.transaccionClasificacionFrm.registro.categoria}" />
                                    <h:outputText value="(no seleccionada)"
                                                  rendered="#{empty transaccionFrm.transaccionClasificacionFrm.registro or empty transaccionFrm.transaccionClasificacionFrm.registro.categoria}" />
                                </h:panelGrid>

                            </h:panelGrid>


                            <p:column headerText="Naturaleza de la cuenta"/>
                            <h:panelGrid columns="2">
                                <!-- Partida Contable - Dos Columnas -->
                                <div style="display: flex; gap: 20px; margin-bottom: 20px;">

                                <!-- COLUMNA DEBE -->
                                <div style="flex: 1; border: 2px solid #d32f2f; border-radius: 8px; padding: 15px; background-color: #fff5f5;">
                                    <h3 style="color: #d32f2f; text-align: center; margin-bottom: 15px;">DEBE</h3>

                                    <p:outputLabel for="autoCompleteDebe" value="Buscar Cuenta Débito:"/>
                                    <p:autoComplete id="autoCompleteDebe"
                                                    value="#{transaccionClasificacionFrm.registro.cuentaContableDebe}"
                                                    completeMethod="#{transaccionClasificacionFrm.completarCuenta}"
                                                    var="cuenta"
                                                    itemLabel="#{cuenta.codigo} - #{cuenta.nombre}"
                                                    itemValue="#{cuenta}"
                                                    forceSelection="true"
                                                    dropdown="true"
                                                    style="width: 100%;"
                                                    required="true">
                                        <p:ajax event="itemSelect"
                                                listener="#{transaccionClasificacionFrm.onCuentaDebeSelect}"
                                                update="infoCuentaDebe infoCuentaHaber validacionPartida"/>
                                    </p:autoComplete>

                                    <!-- Información de la Cuenta Débito Seleccionada -->
                                    <h:panelGroup id="infoCuentaDebe">
                                        <p:outputPanel rendered="#{transaccionClasificacionFrm.registro.cuentaContableDebe != null}">
                                            <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                                                <p style="font-weight: bold; margin: 0 0 5px 0; color: #d32f2f;">Cuenta Débito Seleccionada:</p>
                                                <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px; align-items: center;">
                                                    <strong>Nombre:</strong>
                                                    <span style="color: #007ad9;">#{transaccionClasificacionFrm.registro.cuentaContableDebe.nombre}</span>

                                                    <strong>Código:</strong>
                                                    <code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">
                                                        #{transaccionClasificacionFrm.registro.cuentaContableDebe.codigo}
                                                    </code>

                                                    <strong>Descripción:</strong>
                                                    <span>#{transaccionClasificacionFrm.registro.cuentaContableDebe.descripcion}</span>
                                                </div>
                                            </div>
                                        </p:outputPanel>
                                    </h:panelGroup>
                                </div>

                                <!-- COLUMNA HABER -->
                                <div style="flex: 1; border: 2px solid #388e3c; border-radius: 8px; padding: 15px; background-color: #f5fff5;">
                                    <h3 style="color: #388e3c; text-align: center; margin-bottom: 15px;">HABER</h3>

                                    <p:outputLabel for="autoCompleteHaber" value="Buscar Cuenta Haber:"/>
                                    <p:autoComplete id="autoCompleteHaber"
                                                    value="#{transaccionClasificacionFrm.registro.cuentaContableHaber}"
                                                    completeMethod="#{transaccionClasificacionFrm.completarCuenta}"
                                                    var="cuenta"
                                                    itemLabel="#{cuenta.codigo} - #{cuenta.nombre}"
                                                    itemValue="#{cuenta}"
                                                    forceSelection="true"
                                                    dropdown="true"
                                                    style="width: 100%;"
                                                    required="true">
                                        <p:ajax event="itemSelect"
                                                listener="#{transaccionClasificacionFrm.onCuentaHaberSelect}"
                                                update="infoCuentaDebe infoCuentaHaber validacionPartida"/>
                                    </p:autoComplete>

                                    <!-- Información de la Cuenta Haber Seleccionada -->
                                    <h:panelGroup id="infoCuentaHaber">
                                        <p:outputPanel rendered="#{transaccionClasificacionFrm.registro.cuentaContableHaber != null}">
                                            <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                                                <p style="font-weight: bold; margin: 0 0 5px 0; color: #388e3c;">Cuenta Haber Seleccionada:</p>
                                                <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px; align-items: center;">
                                                    <strong>Nombre:</strong>
                                                    <span style="color: #007ad9;">#{transaccionClasificacionFrm.registro.cuentaContableHaber.nombre}</span>

                                                    <strong>Código:</strong>
                                                    <code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">
                                                        #{transaccionClasificacionFrm.registro.cuentaContableHaber.codigo}
                                                    </code>

                                                    <strong>Descripción:</strong>
                                                    <span>#{transaccionClasificacionFrm.registro.cuentaContableHaber.descripcion}</span>
                                                </div>
                                            </div>
                                        </p:outputPanel>
                                    </h:panelGroup>
                                </div>
                                </div>

                            </h:panelGrid>

                            <p:commandButton id="guardarTodasSelecciones"
                                             value="Guardar selecciones"
                                             icon="pi pi-save"
                                             action="#{transaccionFrm.guardarClasificacionesSeleccionadas}"
                                             process="@this listaTabla seleccionForm"
                                             update="@form messages tablaTransacciones"
                                             onstart="PF('statusDialog').show()"
                                             oncomplete="PF('statusDialog').hide()" />
                        </h:form>
                    </h:panelGroup>

                </h:panelGrid>

            </p:tab>

        </p:tabView>

    </ui:define>

</ui:composition>
