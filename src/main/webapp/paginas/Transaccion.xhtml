<ui:composition
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:ui="jakarta.faces.facelets"
        xmlns:h="jakarta.faces.html"
        xmlns:f="jakarta.faces.core"
        xmlns:p="http://primefaces.org/ui"
        xmlns:ues="jakarta.faces.composite/ues"
        template="/WEB-INF/plantilla/default.xhtml">

    <f:metadata>
        <f:viewParam name="archivoId" value="#{transaccionFrm.idArchivoSeleccionado}"/>
        <f:viewAction action="#{transaccionFrm.cargarTransaccionesDelArchivo}"/>
    </f:metadata>

    <ui:define name="header">
        <h1>Gestión de Transacciones</h1>
    </ui:define>

    <!-- tabla -->
    <ui:define name="contenido-tabla">
        <h:panelGrid>
            <h:form id="frmTablaTransacciones">

                <p:dataTable lazy="true"
                             rendered="#{transaccionFrm.estado == 'NADA'}"
                             rows="50"
                             paginator="true"
                             paginatorPosition="bottom"
                             value="#{transaccionFrm.listaTransacciones}"
                             var="t"
                             rowKey="#{t.id}"
                             selectionMode="single"
                             selection="#{transaccionFrm.registro}"
                             styleClass="tabla-crud">

                    <p:ajax event="rowSelect"
                            listener="#{transaccionFrm.seleccionarRegistro}"
                            update=":pnlDetalle :pnlTabla"/>

                    <p:column headerText="Fecha">
                        <h:outputText value="#{t.fecha}">
                            <f:convertDateTime pattern="dd/MM/yyyy"/>
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Descripción">
                        <h:outputText value="#{t.descripcion}"/>
                    </p:column>

                    <p:column headerText="Monto">
                        <h:outputText value="$#{t.monto}"/>
                    </p:column>

                    <p:column headerText="Moneda">
                        <h:outputText value="#{t.moneda}"/>
                    </p:column>

                </p:dataTable>

                <ues:botones-top formulario="#{transaccionFrm}" actualizar=":pnlDetalle :pnlTabla"/>

            </h:form>
        </h:panelGrid>
    </ui:define>

    <!-- detalle -->
    <ui:define name="contenido-detalle">

        <p:tabView id="tabTransaccion"
                   cache="false"
                   dynamic="true"
                   rendered="#{transaccionFrm.estado != 'NADA'}">

            <!-- Pestaña 1: Detalle de Transacción -->
            <p:tab closable="false" title="Detalle de transacción">

                <h:panelGroup id="pnlTransaccionWrapper">
                    <h:form id="frmTransaccionCrear">

                        <h:panelGrid columns="2">

                            <p:outputLabel for="txtIdTrans" value="ID:"/>
                            <p:inputText id="txtIdTrans"
                                         value="#{transaccionFrm.registro.id}"
                                         readonly="true"
                                         disabled="true"/>

                            <p:outputLabel for="dpFechaTrans" value="Fecha:"/>
                            <p:datePicker id="dpFechaTrans"
                                          value="#{transaccionFrm.registro.fecha}"
                                          pattern="yyyy-MM-dd"
                                          required="true"
                                          showIcon="true"
                                          touchUI="false"/>

                            <p:outputLabel for="txtDescripcion" value="Descripción:"/>
                            <p:inputTextarea id="txtDescripcion"
                                             value="#{transaccionFrm.registro.descripcion}"
                                             rows="3" cols="30"
                                             required="true"
                                             requiredMessage="La descripción es obligatoria."/>

                            <p:outputLabel for="txtMonto" value="Monto:"/>
                            <p:inputNumber id="txtMonto"
                                           value="#{transaccionFrm.registro.monto}"
                                           symbol="$"
                                           required="true"/>

                            <p:outputLabel for="cmbMoneda" value="Moneda:"/>
                            <p:selectOneMenu id="cmbMoneda"
                                             value="#{transaccionFrm.registro.moneda}">
                                <f:selectItem itemLabel="USD" itemValue="USD"/>
                            </p:selectOneMenu>

                        </h:panelGrid>

                        <ues:botones-crud
                                formulario="#{transaccionFrm}"
                                actualizar=":pnlTabla :tabTransaccion"/>

                    </h:form>
                </h:panelGroup>

            </p:tab>

            <!-- Pestaña 2: Clasificación Contable -->
            <p:tab title="Clasificación Contable">
                <h:panelGrid style="width: 100%;">
                    <p:growl id="growlClasificacion" showDetail="true" sticky="true"/>

                    <!-- Información de la Transacción -->
                    <p:panel header="Transacción a Clasificar" style="margin-bottom: 20px;">
                        <h:panelGrid columns="2" style="width: 100%;">
                            <p:outputLabel value="Descripción:" style="font-weight: bold;"/>
                            <p:outputLabel value="#{transaccionFrm.registro.descripcion}"/>

                            <p:outputLabel value="Monto:" style="font-weight: bold;"/>
                            <p:outputLabel value="$#{transaccionFrm.registro.monto}">
                                <f:convertNumber type="currency" currencySymbol="$"/>
                            </p:outputLabel>

                            <p:outputLabel value="Fecha:" style="font-weight: bold;"/>
                            <p:outputLabel value="#{transaccionFrm.registro.fecha}">
                                <f:convertDateTime pattern="dd/MM/yyyy"/>
                            </p:outputLabel>
                        </h:panelGrid>
                    </p:panel>

                    <!-- Formulario de Partida Contable -->
                    <h:form id="frmPartidaContable">

                        <!-- Tipo de Transacción -->
                        <p:panel header="Tipo de Transacción" style="margin-bottom: 20px;">
                            <h:panelGrid columns="2">
                                <p:outputLabel for="selTipoTransaccion" value="Tipo:"/>
                                <p:selectOneMenu id="selTipoTransaccion"
                                                 value="#{transaccionClasificacionFrm.registro.tipoTransaccion}"
                                                 style="width: 200px;"
                                                 required="true">
                                    <f:selectItem itemLabel="Seleccione tipo" itemValue=""/>
                                    <f:selectItem itemLabel="VENTA" itemValue="VENTA"/>
                                    <f:selectItem itemLabel="COMPRA" itemValue="COMPRA"/>
                                    <f:selectItem itemLabel="GASTO" itemValue="GASTO"/>
                                    <f:selectItem itemLabel="INGRESO" itemValue="INGRESO"/>
                                    <f:selectItem itemLabel="PAGO" itemValue="PAGO"/>
                                </p:selectOneMenu>
                            </h:panelGrid>
                        </p:panel>

                        <!-- Partida Contable - Dos Columnas -->
                        <div style="display: flex; gap: 20px; margin-bottom: 20px;">

                            <!-- COLUMNA DEBE -->
                            <div style="flex: 1; border: 2px solid #d32f2f; border-radius: 8px; padding: 15px; background-color: #fff5f5;">
                                <h3 style="color: #d32f2f; text-align: center; margin-bottom: 15px;">DEBE</h3>

                                <p:outputLabel for="autoCompleteDebe" value="Buscar Cuenta Débito:"/>
                                <p:autoComplete id="autoCompleteDebe"
                                                value="#{transaccionClasificacionFrm.registro.cuentaContableDebe}"
                                                completeMethod="#{transaccionClasificacionFrm.completarCuenta}"
                                                var="cuenta"
                                                itemLabel="#{cuenta.codigo} - #{cuenta.nombre}"
                                                itemValue="#{cuenta}"
                                                forceSelection="true"
                                                dropdown="true"
                                                style="width: 100%;"
                                                required="true">
                                    <p:ajax event="itemSelect"
                                            listener="#{transaccionClasificacionFrm.onCuentaDebeSelect}"
                                            update="infoCuentaDebe infoCuentaHaber validacionPartida"/>
                                </p:autoComplete>

                                <!-- Información de la Cuenta Débito Seleccionada -->
                                <h:panelGroup id="infoCuentaDebe">
                                    <p:outputPanel rendered="#{transaccionClasificacionFrm.registro.cuentaContableDebe != null}">
                                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                                            <p style="font-weight: bold; margin: 0 0 5px 0; color: #d32f2f;">Cuenta Débito Seleccionada:</p>
                                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px; align-items: center;">
                                                <strong>Nombre:</strong>
                                                <span style="color: #007ad9;">#{transaccionClasificacionFrm.registro.cuentaContableDebe.nombre}</span>

                                                <strong>Código:</strong>
                                                <code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">
                                                    #{transaccionClasificacionFrm.registro.cuentaContableDebe.codigo}
                                                </code>

                                                <strong>Descripción:</strong>
                                                <span>#{transaccionClasificacionFrm.registro.cuentaContableDebe.descripcion}</span>
                                            </div>
                                        </div>
                                    </p:outputPanel>
                                </h:panelGroup>
                            </div>

                            <!-- COLUMNA HABER -->
                            <div style="flex: 1; border: 2px solid #388e3c; border-radius: 8px; padding: 15px; background-color: #f5fff5;">
                                <h3 style="color: #388e3c; text-align: center; margin-bottom: 15px;">HABER</h3>

                                <p:outputLabel for="autoCompleteHaber" value="Buscar Cuenta Haber:"/>
                                <p:autoComplete id="autoCompleteHaber"
                                                value="#{transaccionClasificacionFrm.registro.cuentaContableHaber}"
                                                completeMethod="#{transaccionClasificacionFrm.completarCuenta}"
                                                var="cuenta"
                                                itemLabel="#{cuenta.codigo} - #{cuenta.nombre}"
                                                itemValue="#{cuenta}"
                                                forceSelection="true"
                                                dropdown="true"
                                                style="width: 100%;"
                                                required="true">
                                    <p:ajax event="itemSelect"
                                            listener="#{transaccionClasificacionFrm.onCuentaHaberSelect}"
                                            update="infoCuentaDebe infoCuentaHaber validacionPartida"/>
                                </p:autoComplete>

                                <!-- Información de la Cuenta Haber Seleccionada -->
                                <h:panelGroup id="infoCuentaHaber">
                                    <p:outputPanel rendered="#{transaccionClasificacionFrm.registro.cuentaContableHaber != null}">
                                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                                            <p style="font-weight: bold; margin: 0 0 5px 0; color: #388e3c;">Cuenta Haber Seleccionada:</p>
                                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px; align-items: center;">
                                                <strong>Nombre:</strong>
                                                <span style="color: #007ad9;">#{transaccionClasificacionFrm.registro.cuentaContableHaber.nombre}</span>

                                                <strong>Código:</strong>
                                                <code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">
                                                    #{transaccionClasificacionFrm.registro.cuentaContableHaber.codigo}
                                                </code>

                                                <strong>Descripción:</strong>
                                                <span>#{transaccionClasificacionFrm.registro.cuentaContableHaber.descripcion}</span>
                                            </div>
                                        </div>
                                    </p:outputPanel>
                                </h:panelGroup>
                            </div>
                        </div>

                        <!-- Validación de Partida Contable -->
                        <h:panelGroup id="validacionPartida">
                            <p:outputPanel>
                                <div style="text-align: center; margin: 20px 0; padding: 15px;
                              background-color: #{transaccionClasificacionFrm.registro.cuentaContableDebe != null and transaccionClasificacionFrm.registro.cuentaContableHaber != null ?
                              '#e8f5e8' : '#fff3e0'};
                              border: 2px solid #{transaccionClasificacionFrm.registro.cuentaContableDebe != null and transaccionClasificacionFrm.registro.cuentaContableHaber != null ?
                              '#388e3c' : '#f57c00'};
                              border-radius: 8px;">
                                    <p style="font-weight: bold; margin: 0; font-size: 1.1em;">
                                        #{transaccionClasificacionFrm.registro.cuentaContableDebe != null and transaccionClasificacionFrm.registro.cuentaContableHaber != null ?
                                                'PARTIDA CONTABLE COMPLETA - Débito y Haber asignados' :
                                                'PARTIDA CONTABLE INCOMPLETA - Seleccione ambas cuentas'}
                                    </p>
                                </div>
                            </p:outputPanel>
                        </h:panelGroup>

                        <!-- SECCIÓN DE SELECCIÓN DE CARACTERÍSTICAS -->
                        <p:panel header="Características de la Cuenta" style="margin-bottom: 20px;" toggleable="true" collapsed="true">
                            <h:panelGrid columns="2" style="width: 100%;">

                                <!-- Características Generales -->
                                <p:panel header="Características Generales" style="margin: 10px;">
                                    <h:panelGrid columns="1">
                                        <p:outputLabel for="selTipoCuenta" value="Tipo de Cuenta:"/>
                                        <p:selectOneMenu id="selTipoCuenta"
                                                         value="#{transaccionClasificacionFrm.registro.tipoCuenta}"
                                                         style="width: 100%;">
                                            <f:selectItem itemLabel="Seleccione tipo" itemValue=""/>
                                            <f:selectItem itemLabel="Activo" itemValue="ACTIVO"/>
                                            <f:selectItem itemLabel="Pasivo" itemValue="PASIVO"/>
                                            <f:selectItem itemLabel="Patrimonio" itemValue="PATRIMONIO"/>
                                            <f:selectItem itemLabel="Ingreso" itemValue="INGRESO"/>
                                            <f:selectItem itemLabel="Gasto" itemValue="GASTO"/>
                                        </p:selectOneMenu>

                                        <p:outputLabel for="selNaturaleza" value="Naturaleza:"/>
                                        <p:selectOneMenu id="selNaturaleza"
                                                         value="#{transaccionClasificacionFrm.registro.naturaleza}"
                                                         style="width: 100%;">
                                            <f:selectItem itemLabel="Seleccione naturaleza" itemValue=""/>
                                            <f:selectItem itemLabel="Deudora" itemValue="DEUDORA"/>
                                            <f:selectItem itemLabel="Acreedora" itemValue="ACREEDORA"/>
                                        </p:selectOneMenu>

                                        <p:outputLabel for="selEstadoCuenta" value="Estado de la Cuenta:"/>
                                        <p:selectOneMenu id="selEstadoCuenta"
                                                         value="#{transaccionClasificacionFrm.registro.estadoCuenta}"
                                                         style="width: 100%;">
                                            <f:selectItem itemLabel="Seleccione estado" itemValue=""/>
                                            <f:selectItem itemLabel="Activa" itemValue="ACTIVA"/>
                                            <f:selectItem itemLabel="Inactiva" itemValue="INACTIVA"/>
                                            <f:selectItem itemLabel="Bloqueada" itemValue="BLOQUEADA"/>
                                        </p:selectOneMenu>
                                    </h:panelGrid>
                                </p:panel>

                                <!-- Características Específicas -->
                                <p:panel header="Características Específicas" style="margin: 10px;">
                                    <h:panelGrid columns="1">
                                        <p:selectBooleanCheckbox id="chkAjustable"
                                                                 value="#{transaccionClasificacionFrm.registro.ajustable}">
                                            <p:ajax update="panelAjustes"/>
                                        </p:selectBooleanCheckbox>
                                        <p:outputLabel for="chkAjustable" value="Ajustable"/>

                                        <p:selectBooleanCheckbox id="chkDepreciable"
                                                                 value="#{transaccionClasificacionFrm.registro.depreciable}">
                                            <p:ajax update="panelDepreciacion"/>
                                        </p:selectBooleanCheckbox>
                                        <p:outputLabel for="chkDepreciable" value="Depreciable"/>

                                        <p:selectBooleanCheckbox id="chkAmortizable"
                                                                 value="#{transaccionClasificacionFrm.registro.amortizable}">
                                            <p:ajax update="panelAmortizacion"/>
                                        </p:selectBooleanCheckbox>
                                        <p:outputLabel for="chkAmortizable" value="Amortizable"/>

                                        <p:selectBooleanCheckbox id="chkAnalitica"
                                                                 value="#{transaccionClasificacionFrm.registro.analitica}"/>
                                        <p:outputLabel for="chkAnalitica" value="Cuenta Analítica"/>
                                    </h:panelGrid>
                                </p:panel>

                            </h:panelGrid>

                            <!-- Panel de Configuración de Ajustes -->
                            <h:panelGroup id="panelAjustes">
                                <p:panel header="Configuración de Ajustes"
                                         rendered="#{transaccionClasificacionFrm.registro.ajustable}"
                                         style="margin-top: 10px;">
                                    <h:panelGrid columns="2">
                                        <p:outputLabel for="selFrecuenciaAjuste" value="Frecuencia de Ajuste:"/>
                                        <p:selectOneMenu id="selFrecuenciaAjuste"
                                                         value="#{transaccionClasificacionFrm.registro.frecuenciaAjuste}"
                                                         style="width: 200px;">
                                            <f:selectItem itemLabel="Mensual" itemValue="MENSUAL"/>
                                            <f:selectItem itemLabel="Trimestral" itemValue="TRIMESTRAL"/>
                                            <f:selectItem itemLabel="Anual" itemValue="ANUAL"/>
                                        </p:selectOneMenu>

                                        <p:outputLabel for="txtMetodoAjuste" value="Método de Ajuste:"/>
                                        <p:inputText id="txtMetodoAjuste"
                                                     value="#{transaccionClasificacionFrm.registro.metodoAjuste}"
                                                     style="width: 200px;"/>
                                    </h:panelGrid>
                                </p:panel>
                            </h:panelGroup>

                            <!-- Panel de Configuración de Depreciación -->
                            <h:panelGroup id="panelDepreciacion">
                                <p:panel header="Configuración de Depreciación"
                                         rendered="#{transaccionClasificacionFrm.registro.depreciable}"
                                         style="margin-top: 10px;">
                                    <h:panelGrid columns="2">
                                        <p:outputLabel for="txtVidaUtil" value="Vida Útil (años):"/>
                                        <p:inputNumber id="txtVidaUtil"
                                                       value="#{transaccionClasificacionFrm.registro.vidaUtil}"
                                                       minValue="1"
                                                       maxValue="100"
                                                       style="width: 150px;"/>

                                        <p:outputLabel for="selMetodoDepreciacion" value="Método de Depreciación:"/>
                                        <p:selectOneMenu id="selMetodoDepreciacion"
                                                         value="#{transaccionClasificacionFrm.registro.metodoDepreciacion}"
                                                         style="width: 200px;">
                                            <f:selectItem itemLabel="Línea Recta" itemValue="LINEA_RECTA"/>
                                            <f:selectItem itemLabel="Saldo Decreciente" itemValue="SALDO_DECRECIENTE"/>
                                            <f:selectItem itemLabel="Unidades Producción" itemValue="UNIDADES_PRODUCCION"/>
                                        </p:selectOneMenu>

                                        <p:outputLabel for="txtValorResidual" value="Valor Residual:"/>
                                        <p:inputNumber id="txtValorResidual"
                                                       value="#{transaccionClasificacionFrm.registro.valorResidual}"
                                                       symbol="$"
                                                       style="width: 150px;"/>
                                    </h:panelGrid>
                                </p:panel>
                            </h:panelGroup>

                            <!-- Panel de Configuración de Amortización -->
                            <h:panelGroup id="panelAmortizacion">
                                <p:panel header="Configuración de Amortización"
                                         rendered="#{transaccionClasificacionFrm.registro.amortizable}"
                                         style="margin-top: 10px;">
                                    <h:panelGrid columns="2">
                                        <p:outputLabel for="txtPeriodoAmortizacion" value="Período Amortización (meses):"/>
                                        <p:inputNumber id="txtPeriodoAmortizacion"
                                                       value="#{transaccionClasificacionFrm.registro.periodoAmortizacion}"
                                                       minValue="1"
                                                       maxValue="360"
                                                       style="width: 150px;"/>

                                        <p:outputLabel for="selMetodoAmortizacion" value="Método de Amortización:"/>
                                        <p:selectOneMenu id="selMetodoAmortizacion"
                                                         value="#{transaccionClasificacionFrm.registro.metodoAmortizacion}"
                                                         style="width: 200px;">
                                            <f:selectItem itemLabel="Línea Recta" itemValue="LINEA_RECTA"/>
                                            <f:selectItem itemLabel="Francés" itemValue="FRANCES"/>
                                            <f:selectItem itemLabel="Alemán" itemValue="ALEMAN"/>
                                        </p:selectOneMenu>
                                    </h:panelGrid>
                                </p:panel>
                            </h:panelGroup>

                            <!-- Características Adicionales -->
                            <p:panel header="Características Adicionales" style="margin-top: 10px;">
                                <h:panelGrid columns="3">
                                    <p:selectBooleanCheckbox id="chkRequiereAprobacion"
                                                             value="#{transaccionClasificacionFrm.registro.requiereAprobacion}"/>
                                    <p:outputLabel for="chkRequiereAprobacion" value="Requiere Aprobación"/>

                                    <p:selectBooleanCheckbox id="chkControlPresupuestario"
                                                             value="#{transaccionClasificacionFrm.registro.controlPresupuestario}"/>
                                    <p:outputLabel for="chkControlPresupuestario" value="Control Presupuestario"/>

                                    <p:selectBooleanCheckbox id="chkConciliacionBancaria"
                                                             value="#{transaccionClasificacionFrm.registro.conciliacionBancaria}"/>
                                    <p:outputLabel for="chkConciliacionBancaria" value="Conciliación Bancaria"/>

                                    <p:selectBooleanCheckbox id="chkMonedaExtranjera"
                                                             value="#{transaccionClasificacionFrm.registro.monedaExtranjera}"/>
                                    <p:outputLabel for="chkMonedaExtranjera" value="Moneda Extranjera"/>

                                    <p:selectBooleanCheckbox id="chkImpuestos"
                                                             value="#{transaccionClasificacionFrm.registro.impuestos}"/>
                                    <p:outputLabel for="chkImpuestos" value="Sujeta a Impuestos"/>

                                    <p:selectBooleanCheckbox id="chkCosto"
                                                             value="#{transaccionClasificacionFrm.registro.costo}"/>
                                    <p:outputLabel for="chkCosto" value="Centro de Costo"/>
                                </h:panelGrid>
                            </p:panel>

                            <!-- Notas y Observaciones -->
                            <p:panel header="Notas y Observaciones" style="margin-top: 10px;">
                                <p:inputTextarea id="txtNotasCaracteristicas"
                                                 value="#{transaccionClasificacionFrm.registro.notasCaracteristicas}"
                                                 rows="3"
                                                 cols="80"
                                                 placeholder="Ingrese observaciones adicionales sobre las características de la cuenta..."/>
                            </p:panel>

                        </p:panel>

                        <!-- Botones de Acción CORREGIDOS -->
                        <div style="text-align: center; margin-top: 20px;">
                            <p:commandButton value="Guardar Clasificación"
                                             action="#{transaccionClasificacionFrm.guardar}"
                                             update="growlClasificacion :pnlTabla"
                                             style="margin-right: 10px;"
                                             disabled="#{transaccionClasificacionFrm.registro.cuentaContableDebe == null or transaccionClasificacionFrm.registro.cuentaContableHaber == null}"/>

                            <p:commandButton value="Cancelar"
                                             action="#{transaccionClasificacionFrm.cancelar}"
                                             process="@this"
                                             update=":tabTransaccion :pnlTabla"
                                             style="margin-right: 10px;"
                                             immediate="true"/>

                            <p:commandButton value="Limpiar"
                                             action="#{transaccionClasificacionFrm.limpiar}"
                                             update="frmPartidaContable"
                                             process="@this"/>
                        </div>

                    </h:form>

                </h:panelGrid>
            </p:tab>

        </p:tabView>

    </ui:define>

</ui:composition>