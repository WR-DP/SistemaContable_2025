<ui:composition
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:ui="jakarta.faces.facelets"
        xmlns:h="jakarta.faces.html"
        xmlns:f="jakarta.faces.core"
        xmlns:p="http://primefaces.org/ui"
        xmlns:ues="jakarta.faces.composite/ues"
        template="/WEB-INF/plantilla/default.xhtml">

    <f:metadata>
        <f:viewParam name="archivoId" value="#{transaccionFrm.idArchivoSeleccionado}"/>
        <f:viewAction action="#{transaccionFrm.cargarTransaccionesDelArchivo}"/>
    </f:metadata>

    <ui:define name="header">
        <h1>Gestión de Transacciones</h1>
    </ui:define>


    <!-- tabla -->
    <ui:define name="contenido-tabla">

        <div style="text-align:left; margin-bottom: 1rem;">
            <p:commandButton
                    value="Volver al Archivo"
                    icon="pi pi-arrow-left"
                    styleClass="btn-clean-green"
                    rendered="#{transaccionFrm.estado == 'NADA'}"
                    onclick="window.location='archivoCargado.jsf'; return false;" />
        </div>

        <h:panelGrid>
            <h:form id="frmTablaTransacciones">
                <h:panelGroup id="pnlTabla">
                    <p:dataTable lazy="true"
                                 rendered="#{transaccionFrm.estado == 'NADA'}"
                                 rows="#{transaccionFrm.pageSize}"
                                 paginator="true"
                                 paginatorPosition="bottom"
                                 value="#{transaccionFrm.listaTransacciones}"
                                 var="t"
                                 rowKey="#{t.id}"
                                 selectionMode="single"
                                 selection="#{transaccionFrm.registro}"
                                 styleClass="tabla-crud">

                        <p:ajax event="rowSelect"
                                listener="#{transaccionFrm.seleccionarRegistro}"
                                update=":pnlDetalle :pnlTabla"/>

                        <p:column headerText="Fecha">
                            <h:outputText value="#{t.fecha}">
                                <f:convertDateTime pattern="dd/MM/yyyy"/>
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Descripción">
                            <h:outputText value="#{t.descripcion}"/>
                        </p:column>

                        <p:column headerText="Monto">
                            <h:outputText value="$#{t.monto}"/>
                        </p:column>

                        <p:column headerText="Moneda">
                            <h:outputText value="#{t.moneda}"/>
                        </p:column>

                    </p:dataTable>
                </h:panelGroup>

                <ues:botones-top formulario="#{transaccionFrm}" actualizar=":pnlDetalle :pnlTabla"/>

            </h:form>
        </h:panelGrid>
    </ui:define>

    <!-- detalla -->
    <ui:define name="contenido-detalle">

        <p:tabView id="tabTransaccion"
                   cache="false"
                   dynamic="true"
                   rendered="#{transaccionFrm.estado != 'NADA'}">
            <p:tab closable="false" title="Detalle de transacción">

                <h:panelGroup id="pnlTransaccionWrapper">
                    <h:form id="frmTransaccionCrear">

                        <div class="form-card-clean">

                            <!-- HEADER -->
                            <div class="form-header-clean">
                                <h2>
                                    <i class="pi pi-dollar"></i>
                                    <h:outputText value="Nueva Transacción" rendered="#{transaccionFrm.estado == 'CREAR'}"/>
                                    <h:outputText value="Editar Transacción" rendered="#{transaccionFrm.estado != 'CREAR'}"/>
                                </h2>
                                <p class="form-subtitle-clean">
                                    Complete los detalles de la transacción contable
                                </p>
                            </div>

                            <!-- BODY -->
                            <div class="form-body-clean">

                                <!-- Fila 1: ID + Fecha -->
                                <div class="form-row">
                                    <div class="form-col">
                                        <label for="txtIdTrans" class="field-label">ID:</label>
                                        <p:inputText id="txtIdTrans"
                                                     value="#{transaccionFrm.registro.id}"
                                                     readonly="true"
                                                     disabled="true"
                                                     styleClass="field-input field-readonly"/>
                                    </div>

                                    <div class="form-col">
                                        <label for="dpFechaTrans" class="field-label">
                                            Fecha: <span class="required-mark">*</span>
                                        </label>
                                        <p:datePicker id="dpFechaTrans"
                                                      value="#{transaccionFrm.registro.fecha}"
                                                      pattern="dd-MM-yyyy"
                                                      required="true"
                                                      requiredMessage="La fecha es obligatoria."
                                                      showIcon="true"
                                                      styleClass="field-input"/>
                                    </div>
                                </div>

                                <!-- Fila 2: Descripción -->
                                <div class="form-row">
                                    <div class="form-col">
                                        <label for="txtDescripcion" class="field-label">
                                            Descripción: <span class="required-mark">*</span>
                                        </label>
                                        <p:inputTextarea id="txtDescripcion"
                                                         value="#{transaccionFrm.registro.descripcion}"
                                                         rows="3"
                                                         placeholder="Descripción de la transacción"
                                                         required="true"
                                                         requiredMessage="La descripción es obligatoria."
                                                         styleClass="field-input"/>
                                    </div>
                                </div>

                                <!-- Fila 3: Monto + Moneda -->
                                <div class="form-row">
                                    <div class="form-col">
                                        <label for="txtMonto" class="field-label">
                                            Monto: <span class="required-mark">*</span>
                                        </label>
                                        <p:inputNumber id="txtMonto"
                                                       value="#{transaccionFrm.registro.monto}"
                                                       symbol="$"
                                                       decimalPlaces="2"
                                                       required="true"
                                                       requiredMessage="Debe ingresar un monto."
                                                       styleClass="field-input"/>
                                    </div>

                                    <div class="form-col">
                                        <label for="cmbMoneda" class="field-label">
                                            Moneda: <span class="required-mark">*</span>
                                        </label>
                                        <p:selectOneMenu id="cmbMoneda"
                                                         value="#{transaccionFrm.registro.moneda}"
                                                         styleClass="field-select">
                                            <f:selectItem itemLabel="USD" itemValue="USD"/>
                                        </p:selectOneMenu>
                                    </div>
                                </div>

                                <!-- Botones CRUD -->
                                <ues:botones-crud
                                        formulario="#{transaccionFrm}"
                                        actualizar=":pnlTabla :tabTransaccion :frmTransaccionCrear"/>


                            </div>
                        </div>

                    </h:form>
                </h:panelGroup>

            </p:tab>

            <!-- clasificacion -->
            <p:tab title="Clasificación Contable"
                   disabled="#{transaccionFrm.estado != 'MODIFICAR'}">
                <h:panelGrid>

                    <h:panelGroup id="pnlClasificacion">
                        <p:growl id="growlClasificacion" showDetail="true"/>
                        <p:growl id="growl-stickyTablaClasificacion" for="sticky-key" showDetail="true"/>

                        <h:form id="frmClasificacion">
                            <h:panelGrid>
                                <h:panelGrid columns="2">
                                    <h:outputLabel for="txtTransaccion" value="Tipo de Transacción:"/>
                                    <p:selectOneMenu id="txtTransaccion"
                                                     value="#{transaccionClasificacionFrm.registro.tipoTransaccion}"
                                                     rendered="#{transaccionFrm.estado == 'MODIFICAR'}">

                                        <f:selectItem itemLabel="Seleccione" itemValue="#{null}"/>
                                        <f:selectItem itemLabel="COMPRA" itemValue="COMPRA"/>
                                        <f:selectItem itemLabel="VENTA" itemValue="VENTA"/>
                                    </p:selectOneMenu>

                                    <p:outputLabel for="acCategoria" value="Categoria :"/>
                                    <h:panelGrid>
                                        <h:panelGrid columns="2">
                                            <p:outputLabel value="Seleccione la categoria: " for="acCategoria"/>
                                            <p:autoComplete id="acCategoria"
                                                            value="#{transaccionClasificacionFrm.categoriaSeleccionada}"
                                                            completeMethod="#{transaccionClasificacionFrm.completarCategoria}"
                                                            var="categoria"
                                                            converter="categoriaConversor"
                                                            itemLabel="#{categoria.nombre}"
                                                            itemValue="#{categoria}"
                                                            forceSelection="true"
                                                            required="true"
                                                            dropdown="true"
                                                            size="40"
                                                            placeholder="Ingrese el nombre de la caracteristica"
                                                            emptyMessage="No se encontraron caracteristica con ese nombre"
                                            />
                                        </h:panelGrid>
                                    </h:panelGrid>


                                    <h:panelGrid>
                                        <h:outputLabel for="txtCategoria" value="Descripción de Categoría:"/>
                                        <h:outputText id="txtCategoria"
                                                      value="#{transaccionClasificacionFrm.registro.categoria.descripcion}"
                                                      rendered="#{not empty transaccionClasificacionFrm.registro and not empty transaccionClasificacionFrm.registro.categoria}"/>
                                        <h:outputText value="(no seleccionada)"
                                                      rendered="#{empty transaccionClasificacionFrm.registro or empty transaccionClasificacionFrm.registro.categoria}"/>
                                    </h:panelGrid>

                                </h:panelGrid>


                                <p:outputLabel for="chkDireccionAsientosContables" value="Direccion de la cuenta:"/>
                                <h:panelGrid>
                                    <p:selectOneRadio id="chkDireccionAsientosContables"
                                                      value="#{transaccionClasificacionFrm.cuentaEsDebe}">
                                        <f:selectItem itemLabel="Debe" itemValue="#{true}"/>
                                        <f:selectItem itemLabel="Haber" itemValue="#{false}"/>
                                        <p:ajax event="change" process="@this"
                                                update="cuentaPanel infoCuentaDebe infoCuentaHaber"/>
                                    </p:selectOneRadio>
                                </h:panelGrid>

                                <h:panelGroup id="cuentaPanel">
                                    <p:outputLabel for="autoCompleteDebe" value="Buscar Cuenta Débito:"
                                                   rendered="#{transaccionClasificacionFrm.cuentaEsDebe}"/>
                                    <p:autoComplete id="autoCompleteDebe"
                                                    value="#{transaccionClasificacionFrm.registro.cuentaContableDebe}"
                                                    completeMethod="#{transaccionClasificacionFrm.completarCuenta}"
                                                    var="cuentaD"
                                                    converter="cuentaConversor"
                                                    itemLabel="#{cuentaD.nombre}"
                                                    itemValue="#{cuentaD}"
                                                    forceSelection="true"
                                                    dropdown="true"
                                                    required="true"
                                                    size="40"
                                                    placeholder="Ingrese el nombre de la cuenta"
                                                    emptyMessage="No se encontraron cuentas con ese nombre"
                                                    rendered="#{transaccionClasificacionFrm.cuentaEsDebe}"/>

                                    <!-- Información de la Cuenta Débito Seleccionada -->
                                    <h:panelGroup id="infoCuentaDebe">
                                        <p:outputPanel
                                                rendered="#{transaccionClasificacionFrm.cuentaEsDebe and transaccionClasificacionFrm.registro.cuentaContableDebe != null}">
                                            <!-- contenido info debe -->
                                        </p:outputPanel>
                                    </h:panelGroup>

                                    <!-- COLUMNA HABER -->
                                    <p:outputLabel for="autoCompleteHaber" value="Buscar Cuenta Haber:"
                                                   rendered="#{not transaccionClasificacionFrm.cuentaEsDebe}"/>
                                    <p:autoComplete id="autoCompleteHaber"
                                                    value="#{transaccionClasificacionFrm.registro.cuentaContableHaber}"
                                                    completeMethod="#{transaccionClasificacionFrm.completarCuenta}"
                                                    var="cuenta"
                                                    converter="cuentaConversor"
                                                    itemLabel="#{cuenta.nombre}"
                                                    itemValue="#{cuenta}"
                                                    forceSelection="true"
                                                    dropdown="true"
                                                    required="true"
                                                    size="40"
                                                    placeholder="Ingrese el nombre de la cuenta"
                                                    emptyMessage="No se encontraron cuentas con ese nombre"
                                                    rendered="#{not transaccionClasificacionFrm.cuentaEsDebe}"/>

                                    <!-- Información de la Cuenta Haber Seleccionada -->
                                    <h:panelGroup id="infoCuentaHaber">
                                        <p:outputPanel
                                                rendered="#{not transaccionClasificacionFrm.cuentaEsDebe and transaccionClasificacionFrm.registro.cuentaContableHaber != null}">
                                            <!-- contenido info haber -->
                                        </p:outputPanel>
                                    </h:panelGroup>
                                </h:panelGroup>

                                <h:panelGrid>
                                    <p:commandButton id="btnGuardarTodo"
                                                     value="Guardar todo"
                                                     icon="pi pi-save"
                                                     action="#{transaccionFrm.guardarTodoDelTab}"
                                                     update=":tabTransaccion:pnlClasificacion "
                                                     process="@form"
                                                     ajax="true"
                                    />
                                </h:panelGrid>

                            </h:panelGrid>

                        </h:form>
                    </h:panelGroup>
                </h:panelGrid>

            </p:tab>

        </p:tabView>

    </ui:define>

</ui:composition>
