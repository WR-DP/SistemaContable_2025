<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:fn="http://java.sun.com/jsp/jstl/functions">
<h:head>
    <title>Transacciones</title>
    <!-- Agrego Bootstrap desde CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
</h:head>

<h:body class="bg-light">
<div class="container py-4">
    <h1 class="mb-4">Lista de Transacciones</h1>

    <h:form id="mainForm">
        <h:messages globalOnly="false" layout="table"/>

        <!-- Panel de facturación (ahora dentro del mismo formulario para que el tipo se envíe al generar) -->
        <div class="card mb-4">
            <div class="card-header">Facturación digital</div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label">Tipo</label>
                        <h:selectOneMenu value="#{transaccionFrm.tipoFacturacion}" styleClass="form-select">
                            <f:selectItem itemValue="" itemLabel="-- Seleccione --" />
                            <f:selectItem itemValue="VENTA" itemLabel="VENTA" />
                            <f:selectItem itemValue="COMPRA" itemLabel="COMPRA" />
                        </h:selectOneMenu>
                    </div>
                    <!-- Eliminados filtros de año/mes/trimestre, sólo filtramos por tipo -->
                </div>

                <div class="mt-3 d-flex gap-2">
                    <h:commandButton value="Aplicar filtro" action="#{transaccionFrm.aplicarFiltroPeriodo}" styleClass="btn btn-secondary" />
                </div>

                <div class="mt-3">
                    <h:panelGroup id="facturacionResult" rendered="#{not empty transaccionFrm.invoiceJson or not empty transaccionFrm.listaParaFacturar}">
                        <div>
                            Registros preparados: <strong>
                                <h:outputText value="#{not empty transaccionFrm.listaParaFacturar ? fn:length(transaccionFrm.listaParaFacturar) : 0}"/>
                            </strong>
                        </div>
                        <h:panelGroup styleClass="mt-2" rendered="#{not empty transaccionFrm.totalesPorMoneda}">
                            <h5>Totales por moneda</h5>
                            <ui:repeat value="#{transaccionFrm.totalesPorMoneda.entrySet().toArray()}" var="entry">
                                <div>#{entry.key}: #{entry.value}</div>
                            </ui:repeat>
                        </h:panelGroup>
                        <div class="mt-3 d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Factura (JSON)</h5>
                                <div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadInvoice()">Descargar JSON</button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <h:inputTextarea id="invoiceJsonArea" value="#{transaccionFrm.invoiceJson}" styleClass="form-control invoice-json-area" rows="12" readonly="true"/>
                            </div>
                        </div>
                    </h:panelGroup>
                </div>
            </div>
        </div>

        <h:panelGroup rendered="#{empty transaccionFrm.listaTransacciones}">
            <div class="alert alert-warning">No se encontraron transacciones en la base de datos.</div>
        </h:panelGroup>

        <h:dataTable value="#{transaccionFrm.listaTransacciones}" var="t"
                     rendered="#{not empty transaccionFrm.listaTransacciones}"
                     styleClass="table table-striped table-hover">

            <f:facet name="header">
                <div class="card">
                    <div class="card-body p-0">
                        <table class="table mb-0">
                            <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Descripción</th>
                                <th class="text-end">Monto</th>
                                <th>Moneda</th>
                                <th>Archivo (ID)</th>
                                <th>Fila Excel</th>
                                <th>Creado</th>
                                <th>Actualizado</th>
                                <th class="text-center">Seleccionar</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </f:facet>

            <h:column>
                <!-- Checkbox de selección: usar la clave String del UUID -->
                <h:selectBooleanCheckbox value="#{transaccionFrm.seleccionMap[t.idTransaccion.toString()]}" />
            </h:column>
            <h:column>
                <h:outputText value="#{t.idTransaccion}" />
            </h:column>
            <h:column>
                <h:outputText value="#{t.fecha}">
                    <f:convertDateTime pattern="dd/MM/yyyy" />
                </h:outputText>
            </h:column>
            <h:column>
                <h:outputText value="#{t.descripcion}" />
            </h:column>
            <h:column>
                <h:outputText value="#{t.monto}" />
            </h:column>
            <h:column>
                <h:outputText value="#{t.moneda}" />
            </h:column>
            <!-- Nuevo: archivo cargado id -->
            <h:column>
                <h:outputText value="#{t.archivoCargadoId != null ? t.archivoCargadoId.id : ''}" />
            </h:column>
            <!-- Nuevo: fila excel -->
            <h:column>
                <h:outputText value="#{t.filaExcel}" />
            </h:column>
            <!-- Nuevo: created_at -->
            <h:column>
                <h:outputText value="#{t.createdAt}">
                    <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
                </h:outputText>
            </h:column>
            <!-- Nuevo: updated_at -->
            <h:column>
                <h:outputText value="#{t.updatedAt}">
                    <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
                </h:outputText>
            </h:column>
            <!-- Quitar botón eliminar: manejamos selección para facturación -->
            <f:facet name="footer">
                <div class="d-flex justify-content-end mt-3 p-2">
                    <h:commandButton value="Generar factura" action="#{transaccionFrm.generarFacturaDigital}" styleClass="btn btn-success" ajax="false" />
                </div>
            </f:facet>
        </h:dataTable>
    </h:form>

</div>

<script>
    function downloadInvoice() {
        const ta = document.querySelector('.invoice-json-area');
        if (!ta) { alert('No se encontró el JSON para descargar.'); return; }
        const invoiceJson = ta.value || ta.textContent || '';
        if (!invoiceJson) { alert('No hay contenido de factura para descargar.'); return; }
        const blob = new Blob([invoiceJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'factura.json');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>
</h:body>
</html>
